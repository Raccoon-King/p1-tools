#!/bin/bash
set -euo pipefail

# P1 Dev Guard Pre-commit Hook
# Fast checks for immediate feedback during development

echo "ğŸ” P1 Dev Guard: Running pre-commit checks..."

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
if [[ -f "${SCRIPT_DIR}/make/.env" ]]; then
    source "${SCRIPT_DIR}/make/.env"
fi

FAILED=0

# Check 1: YAML Syntax Validation
echo "ğŸ“ Checking YAML syntax..."
if command -v yamllint >/dev/null 2>&1; then
    if find . -name "*.yaml" -o -name "*.yml" | xargs yamllint --config-data '{extends: default, rules: {line-length: {max: 120}, indentation: {spaces: 2}}}'; then
        echo "âœ… YAML syntax valid"
    else
        echo "âŒ YAML syntax errors found"
        FAILED=1
    fi
else
    echo "âš ï¸  yamllint not found - skipping YAML validation"
fi

# Check 2: Helm Values Schema Existence
echo "ğŸ“‹ Checking for Helm values schema..."
HELM_CHART_PATH="${HELM_CHART_PATH:-helm/sample-app}"
if [[ -d "${HELM_CHART_PATH}" ]]; then
    if [[ -f "${HELM_CHART_PATH}/values.schema.json" ]]; then
        echo "âœ… values.schema.json found"
    else
        echo "âŒ ${HELM_CHART_PATH}/values.schema.json not found"
        echo "   Generate schema with: helm schema-gen values.yaml > values.schema.json"
        FAILED=1
    fi
else
    echo "âš ï¸  Helm chart directory ${HELM_CHART_PATH} not found - skipping schema check"
fi

# Check 3: No secrets in staged files
echo "ğŸ”’ Scanning for secrets in staged files..."
if command -v git >/dev/null 2>&1; then
    # Get list of staged files
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

    if [[ -n "${STAGED_FILES}" ]]; then
        # Basic secret patterns
        SECRET_PATTERNS=(
            "password\s*=\s*['\"][^'\"]*['\"]"
            "api[_-]?key\s*=\s*['\"][^'\"]*['\"]"
            "secret\s*=\s*['\"][^'\"]*['\"]"
            "token\s*=\s*['\"][^'\"]*['\"]"
            "-----BEGIN.*PRIVATE KEY-----"
            "AKIA[0-9A-Z]{16}"  # AWS Access Key
        )

        for file in ${STAGED_FILES}; do
            if [[ -f "${file}" ]]; then
                for pattern in "${SECRET_PATTERNS[@]}"; do
                    if grep -iE "${pattern}" "${file}" >/dev/null 2>&1; then
                        echo "âŒ Potential secret found in ${file}"
                        echo "   Pattern: ${pattern}"
                        FAILED=1
                    fi
                done
            fi
        done

        if [[ ${FAILED} -eq 0 ]]; then
            echo "âœ… No secrets detected in staged files"
        fi
    else
        echo "âœ… No staged files to check"
    fi
fi

# Check 4: Dockerfile best practices (basic check)
echo "ğŸ³ Checking Dockerfile basics..."
if [[ -f "build/Dockerfile" ]]; then
    # Check for FROM scratch or specific base images (not latest)
    if grep -E "^FROM.*:latest" build/Dockerfile >/dev/null 2>&1; then
        echo "âŒ Dockerfile uses :latest tag"
        echo "   Use specific version tags for reproducible builds"
        FAILED=1
    else
        echo "âœ… No :latest tags found in Dockerfile"
    fi

    # Check for non-root user
    if grep -E "^USER [0-9]+$|^USER [^0]" build/Dockerfile >/dev/null 2>&1; then
        echo "âœ… Dockerfile sets non-root user"
    else
        echo "âŒ Dockerfile should set non-root USER directive"
        FAILED=1
    fi
else
    echo "âš ï¸  build/Dockerfile not found - skipping Dockerfile checks"
fi

# Summary
echo ""
if [[ ${FAILED} -eq 0 ]]; then
    echo "âœ… All pre-commit checks passed!"
    echo "ğŸ’¡ Run 'make verify' for comprehensive Big Bang compliance checks"
    exit 0
else
    echo "âŒ Pre-commit checks failed!"
    echo "ğŸ”§ Fix the issues above before committing"
    echo "ğŸ’¡ Use 'git add' to stage fixes, then commit again"
    exit 1
fi